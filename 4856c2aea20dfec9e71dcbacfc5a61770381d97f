{
  "comments": [
    {
      "key": {
        "uuid": "08418726_215051fd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2017-12-01T12:29:59Z",
      "side": 1,
      "message": "I like this idea but do you mind if we hold on merging this change?\n\nSince upgraded to 2.14, we have this issue[1] which is most likely a bug in Guava cache. When the issue happens, the LoadingCache is unusable until you restart Gerrit.\n\nWe spent a lot of time trying to investigate/reproduce/fix this issue with no luck so far. Investigating this issue made us realize that there are quite a few major issues reported on Guava cache that were never fixed. One of the Guava cache former developer wrote another cache[2] which he claims to be the 2.0 of guava cache.\n\nI have a change which is replacing Guava cache by Caffeine but before uploading it in the open source, I want to run it in production for one two weeks to be sure it fix the problem and do not bring other problems.\n\nEven though I prefer the way the code is in your change, I would like to hold on merging it and if my caffeine test in production is a success, I would prefer that we use a Caffeine cache instead. \n\n[1]https://bugs.chromium.org/p/gerrit/issues/detail?id\u003d7645\n[2]https://github.com/ben-manes/caffeine",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0c944b02_e1dc2353",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-12-01T13:45:50Z",
      "side": 1,
      "message": "Sure, lets hold on submitting.\n\nI am very much interested into your findings about Guava cache vs Caffeine.\nUntil now we were fortunate not to experience issues with Guava caches but it can hit us\nevery day.",
      "parentUuid": "08418726_215051fd",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6bcf334d_b0e841b5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2017-12-04T01:10:42Z",
      "side": 1,
      "message": "Do you mean to replace guava caches in core Gerrit, or only in this plugin?",
      "parentUuid": "0c944b02_e1dc2353",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "38d2f29d_f66bd71d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2017-12-05T04:36:44Z",
      "side": 1,
      "message": "The change I did is replacing guava caches in Gerrit core.\n\nI do not know yet if caffeine will be better than guava so that\u0027s why I will deploy it in prod first. If it turns out to fix the problem and not create others, I will upload my change as a RFC.",
      "parentUuid": "6bcf334d_b0e841b5",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "59286494_1f12e8eb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2017-12-05T05:21:22Z",
      "side": 1,
      "message": "OK, but if it\u0027s on core it\u0027s probably not possible to introduce on the stable-2.14 branch, right?\n\nBTW speaking of caches, Jacek had the idea to use infinispan which provides a distributed cache solution.  We were wondering if it would be a good idea to make the cache implementation pluggable.  What do you think?",
      "parentUuid": "38d2f29d_f66bd71d",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b4a5b820_0c395602",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-12-05T09:29:34Z",
      "side": 1,
      "message": "\u003e BTW speaking of caches, Jacek had the idea to use infinispan which provides a distributed cache solution.  We were wondering if it would be a good idea to make the cache implementation pluggable.  What do you think?\n\n+1\nWith a distributed cache (and elastic search) HA setup would become much more robust IMHO.",
      "parentUuid": "59286494_1f12e8eb",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a073c8d9_b1fe24eb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2017-12-05T14:01:43Z",
      "side": 1,
      "message": "\u003e OK, but if it\u0027s on core it\u0027s probably not possible to introduce on\n \u003e the stable-2.14 branch, right?\n\nEven if this is to fix an issue, it\u0027s too risky to change a core library on a stable branch. I would upload this on master. If people face the same issue, they could cherry pick the change to their fork, the change is pretty small and can easily be cherry-picked.\n\n \u003e \n \u003e BTW speaking of caches, Jacek had the idea to use infinispan which\n \u003e provides a distributed cache solution.  We were wondering if it\n \u003e would be a good idea to make the cache implementation pluggable. \n \u003e What do you think?\n\nI think having the option to have something pluggable is always a good idea.\n\nEvicting the other master cache was the step one to have HA solution. I am looking forward to have a solution where caches are shared within the cluster, same for secondary indexes.",
      "parentUuid": "59286494_1f12e8eb",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f85745f1_c4c3a36f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2017-12-18T18:51:29Z",
      "side": 1,
      "message": "FYI, I tested Gerrit with caffeine cache on slave cluster and every thing looks good so far. I will deploy that on master cluster tomorrow. I will keep you posted if this fixes our cache locking issue and most important, does not cause other problems :)",
      "parentUuid": "a073c8d9_b1fe24eb",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b2e9664b_0ddbf90e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2018-01-08T14:43:13Z",
      "side": 1,
      "message": "\u003e FYI, I tested Gerrit with caffeine cache on slave cluster and every thing looks good so far. I will deploy that on master cluster tomorrow. I will keep you posted if this fixes our cache locking issue and most important, does not cause other problems :)\n\nAny results so far?",
      "parentUuid": "f85745f1_c4c3a36f",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1aa74504_d9167933",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-08T15:26:31Z",
      "side": 1,
      "message": "The problem is we used to have issue with the Guava cache every few days max and now the problem seems to be gone somehow. We kept upgrading to the latest stable-2.14 branch and it looks like we no longer have the right conditions for the issue to happen.\n\nI do not feel like testing a new cache library on our production servers if I do not absolutely need to.\n\nThat said, I think we should no longer hold this change. It would be even better if the issue happens in ha plugin, easier to revert and this would not impact users directly.",
      "parentUuid": "b2e9664b_0ddbf90e",
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "18d571a6_b80abd8a",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/forwarder/rest/AbstractIndexRestApiServlet.java",
        "patchSetId": 2
      },
      "lineNbr": 63,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-08T15:40:42Z",
      "side": 1,
      "message": "Can we have this unlimited? I know it\u0027s unlikely we do more than 1024 indexing but still, this is possible, especially if you trigger the online reindexer on the passive server and the number of batch thread was cranked up.\n\nWe do exactly that use case when we do a major upgrade to speed up the indexing process.",
      "range": {
        "startLine": 63,
        "startChar": 12,
        "endLine": 63,
        "endChar": 30
      },
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5928d2a7_3d583084",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/forwarder/rest/AbstractIndexRestApiServlet.java",
        "patchSetId": 2
      },
      "lineNbr": 64,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-08T15:40:42Z",
      "side": 1,
      "message": "I am not convinced about this eviction policy. Before, the eviction would happen immediately after the last thread release the lock. Now it based on an arbitrary timeout.\n\nThis indexing time is normally really quick but if the change upload a huge file, it can take more than five minutes.",
      "range": {
        "startLine": 64,
        "startChar": 13,
        "endLine": 64,
        "endChar": 51
      },
      "revId": "4856c2aea20dfec9e71dcbacfc5a61770381d97f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}