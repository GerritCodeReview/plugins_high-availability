{
  "comments": [
    {
      "key": {
        "uuid": "e51f1a87_036a6b0f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-06-07T12:45:17Z",
      "side": 1,
      "message": "This is not the right way forward. If we fix this here instead\nof in JGit, it means we will need to do a similar fix in all the\nplugins and Gerrit everytime something is read from the repository.\n\nWe had a few issues in Gerrit and replication plugin caused by exactly\nthe same thing, nfs caching. For testing and quick turn around we decided\nto patch Gerrit in a few places as well as replication plugin but we did\nnot push those patches to the open source because they are not the right\nway forward. We cannot protect every part of the code accessing repositories\nwhich could be hosted on NFS. The proper fix in order to not duplicate code\nevery where is to fix it directly in JGit.\n\nAccording to our tests(based on SAP\u0027s testing who found this work around),\nlisting the files of the parent folder containing the file to read somehow\nmake the other machine see the latest revision, without disabling nfs\nattribute caching.",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1656aa37_0c9c98d9",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-06-07T12:49:28Z",
      "side": 1,
      "message": "@Hugo: I can try your workaround in JGit RefDirectory code. However, I believe your use-case is different: you saw problems all around in JGit with packfiles. Here we see problems ONLY in the alignment where the secondary node doesn\u0027t see in realtime the updated ref.\n\nWe *do not see* any JGit errors, all fine, just there is a lag of visibility of the updated ref, which is perfectly acceptable for a failover node.\n\nWill try the hack you proposed on RefDirectory and will come back to you.",
      "parentUuid": "e51f1a87_036a6b0f",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "33e59580_2e065f3e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-06-07T13:30:12Z",
      "side": 1,
      "message": "Trust me, the issue you have is just the tip of the iceberg of issue of running Gerrit/JGit on NFS. We have been fighting, investigating issues for a a while now :)\n\nHere are 2 examples:\n\n1) replication plugin\n-Gerrit master update create a new ref refs/heads/test\n-Gerrit master schedule replication\n-GC node(JGit gc done from another machine) pack the references\n-Gerrit master start replication\n-Gerrit master replicate nothing because:loose ref refs/heads/test was delete and it sees a stale version of packed-refs without refs/heads/test\n\n2) Gerrit submit commit\n- refs/heads/test exist in repo both, loose is sha1 456 and packed sha1 is 123.\n- GC node pack the references\n- Gerrit master submit a change for ref refs/heads/test\n- Submit strategy think the tip of refs/heads/test is 123 because loose ref was deleted and it sees a stale version of packed-refs with refs/heads/test\u003d123\n\nI know those 2 examples are related to read a stale packed-refs but we have other cases where master node failed to read a loose ref because of NFS delay. My point is if we cannot make JGit behave on NFS, we will keep patching gerrit and plugins but we will never see the end of it.",
      "parentUuid": "1656aa37_0c9c98d9",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e4dcb729_fce34cb1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-06-07T13:38:40Z",
      "side": 1,
      "message": "\u003e Trust me, the issue you have is just the tip of the iceberg of issue of running Gerrit/JGit on NFS. We have been fighting, investigating issues for a a while now :)\n\u003e \n\u003e Here are 2 examples:\n\u003e \n\u003e 1) replication plugin\n\u003e -Gerrit master update create a new ref refs/heads/test\n\u003e -Gerrit master schedule replication\n\u003e -GC node(JGit gc done from another machine) pack the references\n\u003e -Gerrit master start replication\n\u003e -Gerrit master replicate nothing because:loose ref refs/heads/test was delete and it sees a stale version of packed-refs without refs/heads/test\n\u003e \n\u003e 2) Gerrit submit commit\n\u003e - refs/heads/test exist in repo both, loose is sha1 456 and packed sha1 is 123.\n\u003e - GC node pack the references\n\u003e - Gerrit master submit a change for ref refs/heads/test\n\u003e - Submit strategy think the tip of refs/heads/test is 123 because loose ref was deleted and it sees a stale version of packed-refs with refs/heads/test\u003d123\n\u003e \n\u003e I know those 2 examples are related to read a stale packed-refs but we have other cases where master node failed to read a loose ref because of NFS delay. My point is if we cannot make JGit behave on NFS, we will keep patching gerrit and plugins but we will never see the end of it.\n\nYes, but the \"operation\" to fix JGit on NFS shouldn\u0027t kill the patient either ;-)\nI have proposed more a \"refreshRefs()\" method in JGit, so that the in-memory cache can be cleared out before sensitive operations where the caller \"knows about\" the criticality of reading the \"latest and greatest\" always.\n\nIf we had a refreshRefs(), then this fix would become simpler as well.",
      "parentUuid": "33e59580_2e065f3e",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "261f1b95_6f306fe0",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-06-07T13:48:25Z",
      "side": 1,
      "message": "\u003e Yes, but the \"operation\" to fix JGit on NFS shouldn\u0027t kill the patient either ;-)\n\nI know, I am not saying that we need to take Nasser\u0027s change as is, all I want it to fix this in JGit",
      "parentUuid": "e4dcb729_fce34cb1",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2ddc5fce_d786994f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-06-07T13:50:14Z",
      "side": 1,
      "message": "\u003e \u003e Yes, but the \"operation\" to fix JGit on NFS shouldn\u0027t kill the patient either ;-)\n\u003e \n\u003e I know, I am not saying that we need to take Nasser\u0027s change as is, all I want it to fix this in JGit\n\nCool, thanks again for the feedback and will try to apply the hack on the ref snapshot and see if that solves the problem.",
      "parentUuid": "261f1b95_6f306fe0",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "07a17089_6619f5c7",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-06-07T22:29:19Z",
      "side": 1,
      "message": "@Hugo: using the hack reduced *massively* the incidence of the problem. However, I still saw some warnings but, thanks to the retry, the consistency was fixed.\n\nI believe this change is then still valid.\n\nAs a side-effect of the hack, the system load went up *A LOT* and the %CPU more than doubled. The hack in the current form won\u0027t be applicable to us, but possibly may still be OK for your use-case.\n\nGerrit v2.14 does not use loose refs a lot, whilst v2.15 uses and reads them *ALL THE TIMES*. \n\nThis fix on the high-availability plugin is then *specifically targeted* to v2.15 and beyond and it would help my production to be back to a stable alignment.\n\nWould you agree to keep on the review and merge it in the current form? Until we will have identified a viable version of the hack that doesn\u0027t overload the server?",
      "parentUuid": "2ddc5fce_d786994f",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}