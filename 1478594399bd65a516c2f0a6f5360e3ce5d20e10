{
  "comments": [
    {
      "key": {
        "uuid": "e51f1a87_036a6b0f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-06-07T12:45:17Z",
      "side": 1,
      "message": "This is not the right way forward. If we fix this here instead\nof in JGit, it means we will need to do a similar fix in all the\nplugins and Gerrit everytime something is read from the repository.\n\nWe had a few issues in Gerrit and replication plugin caused by exactly\nthe same thing, nfs caching. For testing and quick turn around we decided\nto patch Gerrit in a few places as well as replication plugin but we did\nnot push those patches to the open source because they are not the right\nway forward. We cannot protect every part of the code accessing repositories\nwhich could be hosted on NFS. The proper fix in order to not duplicate code\nevery where is to fix it directly in JGit.\n\nAccording to our tests(based on SAP\u0027s testing who found this work around),\nlisting the files of the parent folder containing the file to read somehow\nmake the other machine see the latest revision, without disabling nfs\nattribute caching.",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1656aa37_0c9c98d9",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-06-07T12:49:28Z",
      "side": 1,
      "message": "@Hugo: I can try your workaround in JGit RefDirectory code. However, I believe your use-case is different: you saw problems all around in JGit with packfiles. Here we see problems ONLY in the alignment where the secondary node doesn\u0027t see in realtime the updated ref.\n\nWe *do not see* any JGit errors, all fine, just there is a lag of visibility of the updated ref, which is perfectly acceptable for a failover node.\n\nWill try the hack you proposed on RefDirectory and will come back to you.",
      "parentUuid": "e51f1a87_036a6b0f",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "33e59580_2e065f3e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 7,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-06-07T13:30:12Z",
      "side": 1,
      "message": "Trust me, the issue you have is just the tip of the iceberg of issue of running Gerrit/JGit on NFS. We have been fighting, investigating issues for a a while now :)\n\nHere are 2 examples:\n\n1) replication plugin\n-Gerrit master update create a new ref refs/heads/test\n-Gerrit master schedule replication\n-GC node(JGit gc done from another machine) pack the references\n-Gerrit master start replication\n-Gerrit master replicate nothing because:loose ref refs/heads/test was delete and it sees a stale version of packed-refs without refs/heads/test\n\n2) Gerrit submit commit\n- refs/heads/test exist in repo both, loose is sha1 456 and packed sha1 is 123.\n- GC node pack the references\n- Gerrit master submit a change for ref refs/heads/test\n- Submit strategy think the tip of refs/heads/test is 123 because loose ref was deleted and it sees a stale version of packed-refs with refs/heads/test\u003d123\n\nI know those 2 examples are related to read a stale packed-refs but we have other cases where master node failed to read a loose ref because of NFS delay. My point is if we cannot make JGit behave on NFS, we will keep patching gerrit and plugins but we will never see the end of it.",
      "parentUuid": "1656aa37_0c9c98d9",
      "range": {
        "startLine": 7,
        "startChar": 0,
        "endLine": 7,
        "endChar": 50
      },
      "revId": "1478594399bd65a516c2f0a6f5360e3ce5d20e10",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}