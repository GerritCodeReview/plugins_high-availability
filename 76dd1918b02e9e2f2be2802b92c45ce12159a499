{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "7f0ce676_c10dd069",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 41,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "Why are we changing the return value here, only for tests? Actually it shouldn\u0027t be needed to signal whether we acquired the lock or not, because we would either call success function or failure function, right? It\u0027s strange to see that the production code is made more complex to satisfy the test setup.",
      "range": {
        "startLine": 41,
        "startChar": 9,
        "endLine": 41,
        "endChar": 29
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9dee9736_77d5a112",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 41,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T22:10:13Z",
      "side": 1,
      "message": "We do need to know if the withLock failed or not: that information was previously swallowed and not accessible.\n\nMaking the code more testable and predictable is definitely a positive goal.",
      "parentUuid": "7f0ce676_c10dd069",
      "range": {
        "startLine": 41,
        "startChar": 9,
        "endLine": 41,
        "endChar": 29
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b19f8fd0_ca64f4e0",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "Leave it non initialized and move the instance creation to lines 61 and 63 where it is actually used.",
      "range": {
        "startLine": 44,
        "startChar": 41,
        "endLine": 44,
        "endChar": 67
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "21be7405_ea83fb9a",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T22:10:13Z",
      "side": 1,
      "message": "I\u0027ll just move it down when it is actually used.",
      "parentUuid": "b19f8fd0_ca64f4e0",
      "range": {
        "startLine": 44,
        "startChar": 41,
        "endLine": 44,
        "endChar": 67
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4075f78a_d808067a",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 59,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "Wouldn\u0027t this be too verbose? If I push batch of 1000 changes at the same time, and the events are forwarded the secondary node, then it\u0027s normal operation, that locks wouldn\u0027t be acquired and we would see tons of log warnings? Change it to lower severity?",
      "range": {
        "startLine": 59,
        "startChar": 6,
        "endLine": 59,
        "endChar": 42
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bfd50c2a_57cf6810",
        "filename": "src/main/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventLocks.java",
        "patchSetId": 4
      },
      "lineNbr": 59,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T22:10:13Z",
      "side": 1,
      "message": "If you push 1000 changes (different ones) you should not get any lock failures and no warnings at all. However, if you push 1000 changes and you have not adjusted the shards, HA plugin won\u0027t work as you\u0027ve expected because you have just 10 shards.\n\nYou *need* to be warned about the misconfiguration sooner rather than later. Logging at fine won\u0027t really help the Gerrit admin to be aware of the problem.",
      "parentUuid": "4075f78a_d808067a",
      "range": {
        "startLine": 59,
        "startChar": 6,
        "endLine": 59,
        "endChar": 42
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ead4c134_20792c4f",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 544,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "This test setup is quite complicate the affairs in this already not small test class. Why not to move the whole IndexEventLocks-related unit test stuff to its own class: IndexEventLocksTest and focus there on this concurrency testing issues, with successful and not successful locking?",
      "range": {
        "startLine": 544,
        "startChar": 2,
        "endLine": 544,
        "endChar": 41
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19f00c76_ae4a8b04",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 544,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "I know, this TestTask is complex because needs to simulate a delayed execution.\nI don\u0027t see any other ways to do it anyway, unless I start again doing massive mocking.\n\nP.S. The whole IndexEventHandlerTest has a lot of complicated mocks that are never tested anyway. I may just give up testing this because the test code is a lot more complicated than the solution?",
      "parentUuid": "ead4c134_20792c4f",
      "range": {
        "startLine": 544,
        "startChar": 2,
        "endLine": 544,
        "endChar": 41
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e7a45705_0d4fd492",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 576,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "This nesting could be avoided. I tried both just remove one call to:\n\n  runLater(\n                        INDEX_WAIT_TIMEOUT_MS * 2,\n\nor even replace it with:\n\n  INDEX_WAIT_TIMEOUT_MS * 4\n\nif you need longer wait timeout?",
      "range": {
        "startLine": 572,
        "startChar": 20,
        "endLine": 576,
        "endChar": 58
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8b50366d_6e7c7247",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 576,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "Not really, the two runLater achieve two different things:\n\n1. Allow having a locking issue between threads\n2. Allow having a delayed release of the lock happening in another thread\n\nDo you see any simpler way to achieve it?",
      "parentUuid": "e7a45705_0d4fd492",
      "range": {
        "startLine": 572,
        "startChar": 20,
        "endLine": 576,
        "endChar": 58
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d34d6f24_b29ec514",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 576,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:56:17Z",
      "side": 1,
      "message": "I believe you\u0027re right: the second runLater() isn\u0027t needed.",
      "parentUuid": "8b50366d_6e7c7247",
      "range": {
        "startLine": 572,
        "startChar": 20,
        "endLine": 576,
        "endChar": 58
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "38ceee77_bee716de",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 595,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "Not used and should be removed.",
      "range": {
        "startLine": 593,
        "startChar": 4,
        "endLine": 595,
        "endChar": 5
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "72247afd_6edbee60",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 595,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "38ceee77_bee716de",
      "range": {
        "startLine": 593,
        "startChar": 4,
        "endLine": 595,
        "endChar": 5
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e3bfe1e_181ebfa3",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 632,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "Test setup would be extremely simplified, if we de-couple IndexEventLocks from IndexEventHandler.IndexTask complexity, and just pass in a index id string, right?",
      "range": {
        "startLine": 632,
        "startChar": 8,
        "endLine": 632,
        "endChar": 89
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0a1b09b1_9ccfc6ed",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 632,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "If we do that, then there isn\u0027t any difference between the test at L630 and the one at L639, isn\u0027t it?\n\nBecause this change is all about checking that a IndexChangeTask and IndexDeleteTask do block each other, we won\u0027t actually test it.",
      "parentUuid": "6e3bfe1e_181ebfa3",
      "range": {
        "startLine": 632,
        "startChar": 8,
        "endLine": 632,
        "endChar": 89
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "289e8172_2254e3d1",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 634,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "New instance shouldn\u0027t be needed, you could just pass in indexTask1 as well, as both instances would produce the same index id.",
      "range": {
        "startLine": 633,
        "startChar": 4,
        "endLine": 634,
        "endChar": 89
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fa0da9a7_77f91e69",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 634,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "Ack, but that isn\u0027t what it will actually happen in reality, as there will be different tasks objects created.\n\nI know this isn\u0027t a proper black-box testing, but we should aim to be as much as possible closer to the real execution. But I got your point, and we could simplify it.",
      "parentUuid": "289e8172_2254e3d1",
      "range": {
        "startLine": 633,
        "startChar": 4,
        "endLine": 634,
        "endChar": 89
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1214d283_e2ca3f34",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 672,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-12-17T14:56:07Z",
      "side": 1,
      "message": "May be add a comment to clarify, that the order doesn\u0027t matter here, so that we don\u0027t know, whether the first or the second task will succeed or fail? The reason is the usage of CyclicBarrier, if you wouldn\u0027t use it, then the test would succeed  too, but the first task would probably always succeed.",
      "range": {
        "startLine": 671,
        "startChar": 4,
        "endLine": 672,
        "endChar": 52
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5898435b_022a9a30",
        "filename": "src/test/java/com/ericsson/gerrit/plugins/highavailability/index/IndexEventHandlerTest.java",
        "patchSetId": 4
      },
      "lineNbr": 672,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-12-17T15:46:44Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "1214d283_e2ca3f34",
      "range": {
        "startLine": 671,
        "startChar": 4,
        "endLine": 672,
        "endChar": 52
      },
      "revId": "76dd1918b02e9e2f2be2802b92c45ce12159a499",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}